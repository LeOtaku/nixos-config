import sys
import pytoml as toml
from git import Repo
from git.remote import RemoteProgress
from os.path import join
import os

def lineprint(string):
    sys.stdout.flush()
    sys.stdout.write(u"\u001b[1000D" + string)
    sys.stdout.flush()

class Progress(RemoteProgress):
    def update(self, op_code, cur_count, max_count=None, message=''):
        lineprint(self._cur_line)

class Module():
    def __init__(self, path, sources):
        try: 
            self.repo = Repo(path)
            assert not repo.bare
        except:
            self.repo = Repo.init(path)
        self.sources = sources
        self._addRemotes()

    def _addRemotes(self):
        repo = self.repo
        for remote in self.sources:
            rname = remote["name"]
            url = remote["src"]
            if not hasattr(repo.remotes, rname):
                repo.create_remote(rname, url)
            elif not repo.remotes[rname].url == url:
                repo.remotes[rname].set_url(old_url=url, new_url=repo.remotes[rname].url)

    def update(self):
        for robj in self.repo.remotes:
            robj.fetch(progress=Progress())
            print("Updated remote '{0}'".format(robj))

    def checkout(self, ref):
        self.repo.git.checkout(ref)

class Deployment():
    def __init__(self, modules, modulerefs):
        self.checkouts = {}
        for moduleref in modulerefs:
            name, ref = moduleref["name"], moduleref["ref"]
            self.checkouts[name] = { "ref": ref, "module": modules[name] }

            
class ConfigObject():
    def __init__(self, file, path, main_name):
        self.toml = toml.load(file)
        #self.locks = toml.load(lockfile)
        self.path = path
        self.modules = {}
        for module in self.toml["module"]:
            name = module["name"]
            repopath = join(path, name)
            self.modules[name] = Module(repopath, module["sources"])

        self.deployments = {}
        for desc in self.toml["deployment"]:
            depl = Deployment(self.modules, desc["modules"])
            self.deployments[desc["name"]] = depl
            if desc["name"] == main_name:
                self.deployments["main"] = depl


    def update_modules(self):
        for name, module in self.modules.items():
            print("Updating repo '{0}'".format(name))
            module.update()
    
    def checkout(self, depl_name, silent=True):
        depl = self.deployments[depl_name]
        for name, checkout in depl.checkouts.items():
            module, ref = checkout["module"], checkout["ref"]
            if not silent: print("Checking out '{0}' on '{1}'".format(ref, name))
            module.checkout(ref)

    def run_as(self, depl_name, cmd):
        try:
            self.checkout(depl_name)
            os.system(cmd)
        finally:
            self.checkout("main")

#with open("./nixos.toml") as fin:
#    config = ConfigObject(fin, ".")
